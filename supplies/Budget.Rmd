---
title: "General Lab Budget"
author: "Alicia Rich"
output:
  html_document:
    theme:
      bootswatch: flatly
    toc: false
    code_folding: "hide"
    fig_caption: true
    df_print: paged
                     
---

```{r, include = F}
global             <- config::get(config = "default")

here::i_am("supplies/Budget.Rmd")
source(here::here(global$setup))
source(here("supplies/consumables_concise.R"))
source(here("supplies/portable_lab.R"))

```

# Overview and Introduction

## Purpose

This is a broad estimated budget for the Rich Lab's fiscal year costs. It includes some of our routine supplies that should remain constant year-to-year and some of the project-specific infrastructure that will generate enough pilot data to secure a federal grant.

## Time Frame

Academic Year 2025 - 2026

# Budget

```{r, include = FALSE}

budget_cols <- c(
      "Project",
      "Category",
      "Supplies",
      "Title",
      "Cost_total",
      "N",
      "Price",
      "Manuf",
      "Cat",
      "N_each",
      "N_needed",
      "Link"
)

make_total <- function(df) {
  df <- df %>% rowwise() %>%
    mutate(Cost_month = Each * N_month,
           Cost_year  = 12 * (Each * N_month)) %>%
    ungroup()
  
  return(df)
}

equip_total <- function(df) {
  df <- df %>% rowwise() %>%
    mutate(Cost_year  = Each * N_year) %>%
    ungroup() %>%
    rename(Supplies   = Purpose,
           Price      = Each,
           N_needed   = N_year,
           Cost_total = Cost_year) %>%
    mutate(Project = "General",
           N       = N_needed,
           N_each  = 1)
  
  return(df)
}

project_total <- function(df, project) {
  df <- df %>% rowwise() %>%
    mutate(
      N_each         = floor(preps * samples_prep),
      N_needed       = ceiling(Samples/N_each),
      Cost_total     = N_needed * Each,
      Project        = project,
      Supplies       = fct(str_to_title(Category), levels = c(
        "Kits",
        "Reagents",
        "Flowcells",
        "Tubes",
        "Tips"
      )
      )
    ) %>%
    mutate(Category = "Consumables") %>%
    select(
      Category,
      Project,
      Supplies,
      Title,
      Cost_total,
      N_each,
      N = Samples,
      N_needed,
      Price = Each,
      Manuf,
      Cat,
      Link
    ) %>%
    relocate(all_of(budget_cols)) %>%
    arrange(
      Supplies,
      Manuf,
      Cat
    )
}

```


## Personnel

```{r, include = FALSE}
lab.manager <- tibble(
  Category = "Personnel",
  Title    = "Lab Technician",
  Each     = 15,
  Per      = "hours",
  N_month  = 80
) %>% make_total()

work.study <- tibble(
  Category = "Personnel",
  Title    = "Work Study Undergrads",
  Each     = 3.75,
  Per      = "hour",
  N_month  = 40
) %>% make_total()

personnel <- bind_rows(lab.manager, work.study) %>%
  rename(Price      = Each, 
         Cost_total = Cost_year,
         N          = N_month) %>%
  mutate(Project    = "General",
         N_needed   = N * 12, 
         N_each     = 1,
         Link       = NA, 
         Cat        = NA,
         Supplies   = Title,
         Manuf      = NA) %>%
  select(all_of(budget_cols))
```

## Travel



## Equipment

```{r, include = FALSE}
sequencers <- tibble(
  Category = "Equipment",
  Title    = c("MinION Mk1d Sequencer", "Flongle Starter Pack"),
  Manuf    = "ONT",
  Link     = c("https://store.nanoporetech.com/us/minion.html", "https://store.nanoporetech.com/us/flongle-intro-pack-2.html"),
  Cat      = c("MIN-101D", "FLGIntSP"),
  Each     = c(2999, 1995),
  Per      = c("device", "pack"),
  N_year   = c(2, 1),
  Purpose  = c("DNA Sequencing", "DNA Sequencing")
) %>% equip_total()

computers <- tibble(
  Category = "Equipment",
  Title    = "Linux High Performance Workstation",
  Manuf    = "system76",
  Link     = "https://system76.com/desktops/thelio-major-r5-n3/configure",
  Cat      = "thelio-major-r5-n3",
  Each     = 4554,
  Per      = "device",
  N_year   = 1,
  Purpose  = "DNA Sequencing"
) %>% equip_total()

portable.lab <- enframe(portable$equipment, name = "Title") %>%
  mutate(Category = "Equipment") %>%
  unnest_wider(value) %>% equip_total()

equipment <- tibble(
  Category = "Equipment",
  Title    = "UV 30W, (G30T8) Germicidal Lamp",
  Link     = "https://a.co/d/hJlNPLC",
  Manuf    = "Sylvania",
  Cat      = NA,
  Each     = 19.46,
  Per      = "item",
  N_year   = 1,
  Purpose  = "DNA Extraction"
) %>%
  equip_total() %>%
  bind_rows(sequencers, computers, portable.lab) %>%
  select(all_of(budget_cols))
```

### Consumables 

```{r}
consumables_table <- enframe(consumables, name = "Category") %>%
  unnest_longer(value, indices_to = "Title") %>%
  unnest_wider(value)
bat_eDNA <- consumables_table %>% 
  filter(Title != "Ligation Sequencing Kit" &
         Title != "16S Barcoding Kit 24"    &
         Title != "LongAmp Hot Start Taq 2X Master Mix" &
         Title != "NEBNext速 Companion Module v2" &
         Title != "T7 Endonuclease I" &
         Title != "Blunt/TA Ligase" &
         Title != "MinION" &
         Title != "DNA/RNA Shield" &
         Title != "DNA/RNA Shield Lysis Tubes (Microbe)" &
         Title != "2mL Collection Tubes" &
         Title != "5mL Collection Tubes"
         ) %>%
  mutate(Samples = 50) %>%
  project_total("eDNA Endangered Bats")
bat_microbiome <- consumables_table %>% 
  filter(Title != "Ligation Sequencing Kit" &
         Title != "Rapid Barcoding Kit 24"    &
         Title != "NEBNext速 Companion Module v2" &
         Title != "REPLI-g UltraFast Mini Kit" &
         Title != "T7 Endonuclease I" &
         Title != "Blunt/TA Ligase" &
         Title != "MinION" &
         Title != "DNA/RNA Shield" 
         ) %>%
  mutate(Samples = 200) %>%
  project_total("Urbanization Bat Health")
salci <- consumables_table %>% 
  filter(Title != "Rapid Barcoding Kit 24" &
         Title != "16S Barcoding Kit 24"    &
         Title != "LongAmp Hot Start Taq 2X Master Mix" &
         Title != "MinION" &
         Title != "DNA/RNA Shield" &
         Title != "2mL Collection Tubes" &
         Title != "5mL Collection Tubes"
         ) %>%
  mutate(Samples = 30) %>%
  project_total("Lithium Tolerant Microbial Communities")
loris_taxonomy <- consumables_table %>% 
  filter(Title != "Ligation Sequencing Kit" &
         Title != "16S Barcoding Kit 24"    &
         Title != "LongAmp Hot Start Taq 2X Master Mix" &
         Title != "NEBNext速 Companion Module v2" &
         Title != "T7 Endonuclease I" &
         Title != "Blunt/TA Ligase" &
         Title != "MinION" &
         Title != "DNA/RNA Shield Lysis Tubes (Microbe)" &
         Title != "2mL Collection Tubes"
         ) %>%
  mutate(Samples = 60) %>%
  project_total("Pygmy Loris Taxonomy/Phylogenetics")
loris_microbiomes <- consumables_table %>% 
  filter(Title != "Ligation Sequencing Kit" &
         Title != "Rapid Barcoding Kit 24"    &
         Title != "NEBNext速 Companion Module v2" &
         Title != "REPLI-g UltraFast Mini Kit" &
         Title != "T7 Endonuclease I" &
         Title != "Blunt/TA Ligase" &
         Title != "MinION" &
         Title != "DNA/RNA Shield Lysis Tubes (Microbe)" &
         Title != "2mL Collection Tubes"
         ) %>%
  mutate(Samples = 400) %>%
  project_total("Pygmy Loris Molecular Health")
```


```{r}
projects <- c(
  "General",
  "Pygmy Loris Molecular Health",
  "Pygmy Loris Taxonomy/Phylogenetics",
  "Urbanization Bat Health",
  "eDNA Endangered Bats",
  "Lithium Tolerant Microbial Communities"
)

categories <- c(
  "Personnel",
  "Equipment",
  "Consumables"
)

supplies <- c(
        "Lab Technician",
        "Work Study Undergrads",
        "Portable Lab",
        "Sample Collection",
        "DNA Extraction",
        "Quality Control",
        "Library Prep",
        "DNA Sequencing",
        "Kits",
        "Reagents",
        "Flowcells",
        "Tubes",
        "Tips"
)
```


```{r}
budget_summary <- bind_rows(
  loris_microbiomes,
  loris_taxonomy,
  salci,
  bat_microbiome,
  bat_eDNA,
  equipment, 
  personnel) %>%
  mutate(Project  = fct(Project , levels = projects),
         Category = fct(Category, levels = categories),
         Supplies = fct(Supplies, levels = supplies)) %>%
  relocate(all_of(budget_cols)) %>%
  arrange(Project, Category, Supplies)
```

```{r}
project_budgets <- budget_summary %>%
  group_by(Project, Category) %>%
  group_split() %>%
  set_names(map_chr(., ~ paste(unique(.x$Project),
                                unique(.x$Category),
                                sep = "_")))


proj_summary <- tibble(
  Index      = names(project_budgets),
  Project    = str_remove_all(names(project_budgets), "_.+$"),
  Category   = str_remove_all(names(project_budgets), "^.+_"),
  Subtotal   = map_dbl(project_budgets, ~ sum(.x$Cost_total, na.rm = TRUE))
)
```


```{r}
project_supplies_budgets <- budget_summary %>%
  group_by(Project, Category, Supplies) %>%
  group_split() %>%
  set_names(map_chr(., ~ paste0(unique(.x$Project),
                                "_",
                                unique(.x$Category),
                                ":",
                                unique(.x$Supplies))))
```


```{r}
supplies_summary <- tibble(
  Index      = str_remove_all(names(project_supplies_budgets), ":.+$"),
  Project    = str_remove_all(names(project_supplies_budgets), "_.+$"),
  Category   = str_extract_all(names(project_supplies_budgets), "(?<=_)\\w+(?=:.+$)"),
  Supplies   = str_remove_all(names(project_supplies_budgets), "^.+:"),
  Cost       = map_dbl(project_supplies_budgets, ~ sum(.x$Cost_total, na.rm = TRUE))
)
```

```{r}
budget.react <- reactable(
  proj_summary,
  fullWidth       = FALSE,
  groupBy        = "Project",
  theme           = fivethirtyeight(),
  defaultExpanded = TRUE,
  defaultColDef   = colDef(footerStyle = list(fontWeight = "bold")),
  columns = list(
    Index     = colDef(show = FALSE),
    Project   = colDef(name       = "Project or Category",
                       footer     = "Grand Total",
      rowHeader = TRUE,
      grouped   = JS("function(cellInfo) {
                        return cellInfo.value;
                      }")),
    Category  = colDef(name = ""),
    Subtotal  = colDef(
      name   = "Subtotal",
      aggregate = "sum", 
      format    = list(aggregated = colFormat(currency = "USD", separators = TRUE)),
      cell      = data_bars(
                    proj_summary, 
                    text_position = "outside-end", 
                    box_shadow    = TRUE, 
                    number_fmt    = label_currency(prefix = "$", big.mark = ",")
                  ),
      footer    = function(values, name) {
                    total <- sum(values, na.rm = TRUE)
                    label_currency(prefix = "$", big.mark = ",")(total)
                  }
    )
  ),
  details = function(index) {
      value <- supplies_summary$Supplies[Index]
    }
) %>% add_title("Budget Summary")
```


```{r}
budget.react <- reactable(
  proj_summary,
  fullWidth       = FALSE,
  theme           = fivethirtyeight(),
  defaultExpanded = FALSE,
  defaultColDef   = colDef(footerStyle = list(fontWeight = "bold")),
  columns = list(
    Project   = colDef(name       = "Project",
                       footer     = "Grand Total",
      rowHeader = TRUE,
      grouped   = JS("function(cellInfo) {
                        return cellInfo.value;
                      }")),
    Subtotal  = colDef(
      name   = "Cost Subtotal",
      format = colFormat(currency = "USD", separators = TRUE),
      footer    = function(values, name) {
                    total <- sum(values, na.rm = TRUE)
                    label_currency(prefix = "$", big.mark = ",")(total)
                  }
    )
  ),
      details = function(index) {
        cat_val <- cat_summary$Category[cat_index]
        
        supplies <- project_supplies_budgets %>% 
          keep(~ unique(.x$Project) == proj_val & unique(.x$Category) == cat_val)
        
        if (length(supplies) == 0) return(NULL)
        supp_summary <- tibble(
          Supplies  = map_chr(supplies, ~ unique(.x$Supplies)),
          TotalCost = map_dbl(supplies, ~ sum(.x$Cost_total, na.rm = TRUE))
        )
        
reactable(supp_summary,
  fullWidth       = FALSE,
  theme           = fivethirtyeight(),
  outlined        = TRUE,
  defaultColDef   = colDef(footerStyle = list(fontWeight = "bold")),
  defaultExpanded = FALSE,
          columns = list(
            Supplies  = colDef(name = "Supplies",
      ),
            TotalCost = colDef(
              name = "Total Cost",
              format = colFormat(currency = "USD", separators = TRUE),
      footer    = function(values, name) {
                    total <- sum(values, na.rm = TRUE)
                    label_currency(prefix = "$", big.mark = ",")(total)
                  }
            )
          )
        )
      }
    )
  }
)
```

```{r}
budget.react <- reactable(
  budget_summary,
  height          = 800,
  theme           = fivethirtyeight(),
  groupBy         = c("Category", "Project", "Supplies"),
  defaultExpanded = FALSE,
  columns         = list(
    Category = colDef(
      name      = "",
      footer    = "Total", 
      rowHeader = TRUE,
      grouped   = JS("function(cellInfo) {
                        return cellInfo.value;
                      }")
    ),
    Project = colDef(
      grouped = JS("function(cellInfo) {
                        return cellInfo.value;
                      }")
    ),
    Supplies = colDef(
      grouped = JS("function(cellInfo) {
                        return cellInfo.value;
                      }")
    ),
    Title = colDef(
      name = "",
    ),
    Cost_total = colDef(
      name      = "Total Cost",
      cell      = data_bars(
                    budget_summary, 
                    text_position = "outside-end", 
                    box_shadow    = TRUE, 
                    number_fmt    = label_currency(prefix = "$", big.mark = ",")
                  ),
      aggregate = "sum", 
      format    = list(aggregated = colFormat(currency = "USD", separators = TRUE)),
      footer    = function(values, name) {
                    total <- sum(values, na.rm = TRUE)
                    label_currency(prefix = "$", big.mark = ",")(total)
                  }
    ),
    N = colDef(name = "N", aggregate = "median"),
    Price = colDef(name = "Price/Unit"),
    Manuf = colDef(
      name  = "Manufacturer",
      cell  = pill_buttons(opacity = 0.5, text_size = 9.5, box_shadow = TRUE),
      style = cell_style(horizontal_align = "right")
    ),
    Cat = colDef(
      name = "Catalog", 
      cell = function(value) { tags$small(tags$pre(value)) }
    ),
    N_each   = colDef(show = FALSE),
    N_needed = colDef(show = FALSE),
    Link     = colDef(show = FALSE)
  ),
  defaultColDef = colDef(footerStyle = list(fontWeight = "bold"))
) %>% add_title("Budget Summary")
```


```{r}


budget.react <- reactable(
  budget_summary,
  height          = 800,
  theme           = fivethirtyeight(),
  groupBy         = c("Category", "Project", "Supplies"),
  defaultExpanded = FALSE,
  columns         = list(
    Category      = colDef(footer    = "Total", 
                           rowHeader = TRUE,
                           grouped = JS("function(cellInfo) {
                               return cellInfo.value
                             }")
                           ),
    Project       = colDef(
                          
                          grouped = JS("function(cellInfo) {
                               return cellInfo.value
                             }")
                           ),
    Supplies      = colDef(grouped = JS("function(cellInfo) {
                               return cellInfo.value
                             }")
                           ),
    
    Title         = colDef(name = ""),
    
    Cost_total = colDef(
                         name      = "Total Cost",
                         cell      = data_bars(
                                          budget_summary, 
                                          text_position = "outside-end", 
                                          box_shadow    = TRUE, 
                                          number_fmt    = label_currency(prefix = "$", big.mark = ",")
                                          ),
                         aggregate = "sum", 
                         format    = list(aggregated = colFormat(currency = "USD", separators = TRUE)),
                         footer    = function(values, name) {
                                                          total <- sum(values, na.rm = TRUE)
                                                          label_currency(prefix = "$", big.mark = ",")(total)
                                                        }
                         ), 
    
    N             = colDef(name = "N", aggregate = "median"),
    
    Price         = colDef(name      = "Price/Unit"),
    
    Manuf      = colDef(
                          name  = "Manufacturer",
                          cell  = pill_buttons(opacity = 0.5, text_size = 9.5, box_shadow = TRUE),
                          style = cell_style(horizontal_align = "right")
                        ),
    
    Cat        = colDef(
                        name = "Catalog", 
                        cell = function(value) {
                                                tags$small(tags$pre(value))
                                              }
                        ),
    
    N_each        = colDef(show = FALSE),
    N_needed      = colDef(show = FALSE),
    Link          = colDef(show = FALSE)
  ),
  defaultColDef = colDef(footerStyle = list(fontWeight = "bold"))
) %>% add_title("Budget Summary")
```




## Travel

## Other Expenses

